---
import Layout from '../../../layouts/Layout.astro';
import { StorageService } from '../../../lib/storage';

const { id } = Astro.params;

// Get the product
const product = StorageService.getProduct(id as string);

// Redirect to home if product not found
if (!product) {
  return Astro.redirect('/');
}

// Format date for input
const formattedDate = new Date(product.lastPurchasedAt).toISOString().split('T')[0];
---

<Layout title="Edit Product">
  <div class="max-w-2xl mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h2 class="text-2xl font-bold mb-6">Edit Product</h2>
      
      <form id="productForm" class="space-y-4">
        <input type="hidden" id="productId" value={product.id} />
        
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
            Product Name
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            value={product.name}
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="e.g., Milk, Bread, Shampoo"
          />
        </div>
        
        <div>
          <label for="price" class="block text-sm font-medium text-gray-700 mb-1">
            Price
          </label>
          <input
            type="number"
            id="price"
            name="price"
            required
            min="0"
            step="0.01"
            value={product.priceLatest}
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="0.00"
          />
        </div>
        
        <div>
          <label for="lastsDays" class="block text-sm font-medium text-gray-700 mb-1">
            Lasts for (days)
          </label>
          <input
            type="number"
            id="lastsDays"
            name="lastsDays"
            required
            min="1"
            value={product.lastsDays}
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <p class="text-sm text-gray-500 mt-1">How many days until you need to buy it again</p>
        </div>
        
        <div>
          <label for="lastPurchasedAt" class="block text-sm font-medium text-gray-700 mb-1">
            Last Purchased
          </label>
          <input
            type="date"
            id="lastPurchasedAt"
            name="lastPurchasedAt"
            required
            value={formattedDate}
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>
        
        <div>
          <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
            Notes (optional)
          </label>
          <textarea
            id="notes"
            name="notes"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Any additional notes..."
          >{product.notes || ''}</textarea>
        </div>
        
        <div class="flex gap-3 pt-4">
          <button
            type="submit"
            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
          >
            Save Changes
          </button>
          <button
            type="button"
            id="deleteBtn"
            class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition-colors"
          >
            Delete
          </button>
          <a
            href="/"
            class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors text-center"
          >
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script>
  import { StorageService } from '../../../lib/storage';
  import { categorizeProduct } from '../../../types/models';
  
  // Handle form submission
  const form = document.getElementById('productForm') as HTMLFormElement;
  const deleteBtn = document.getElementById('deleteBtn') as HTMLButtonElement;
  const productId = (document.getElementById('productId') as HTMLInputElement).value;
  
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const name = formData.get('name') as string;
    const price = parseFloat(formData.get('price') as string);
    const lastsDays = parseInt(formData.get('lastsDays') as string);
    const lastPurchasedAt = new Date(formData.get('lastPurchasedAt') as string);
    const notes = formData.get('notes') as string;
    
    // Auto-categorize the product
    const category = categorizeProduct(name);
    
    // Update product
    StorageService.updateProduct(productId, {
      name,
      priceLatest: price,
      lastsDays,
      lastPurchasedAt,
      notes: notes || undefined,
      category
    });
    
    // Redirect to products list
    window.location.href = '/';
  });
  
  // Handle delete
  deleteBtn.addEventListener('click', () => {
    if (confirm('Are you sure you want to delete this product?')) {
      StorageService.deleteProduct(productId);
      window.location.href = '/';
    }
  });
</script>
